<!DOCTYPE html>
<html lang="ru" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑˆÑ‚Ñ€Ğ¸Ñ…ĞºĞ¾Ğ´Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'Alef', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .container {
      max-width: 380px;
      margin: 32px auto;
      background: #fff;
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(30,136,229,0.1);
    }
    .qr-area {
      background: #e3f2fd;
      padding: 20px;
      margin: 16px 0;
      border-radius: 12px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin: 10px;
    }
    .danger-btn {
      background: #e53935;
      color: #fff;
    }
    .secondary-btn {
      background: #43a047;
      color: #fff;
    }
    .result-box {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 14px;
      border-radius: 8px;
      font-weight: bold;
      margin-top: 20px;
    }
    .loader {
      border: 4px solid #e3f2fd;
      border-top: 4px solid #1e88e5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1.2s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .hidden { display: none; }
    .visible { display: block; }
    #error-box {
      color: #b71c1c;
      background: #ffebee;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="page-scan-order" class="visible">
      <h1>Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑˆÑ‚Ñ€Ğ¸Ñ…ĞºĞ¾Ğ´Ğ° Ğ·Ğ°ĞºĞ°Ğ·Ğ°</h1>
      <h2>ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑˆÑ‚Ñ€Ğ¸Ñ…ĞºĞ¾Ğ´ Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ°</h2>
      <div class="qr-area">
        <div id="qr-reader-order"></div>
      </div>
      <button onclick="startOrderScan()">ğŸ“· ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</button>
      <button class="danger-btn" onclick="goHome()">â¬… ĞĞ°Ğ·Ğ°Ğ´ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</button>
    </div>

    <div id="page-loading" class="hidden">
      <h1>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...</h1>
      <div class="loader"></div>
      <div id="error-box"></div>
      <button class="danger-btn" onclick="goHome()">â¬… ĞĞ°Ğ·Ğ°Ğ´ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</button>
    </div>

    <div id="page-room-result" class="hidden">
      <h1>ĞšĞ»ÑÑ‡ Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹</h1>
      <div class="result-box">
        ĞĞ¾Ğ¼ĞµÑ€ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹: <span id="room-number" style="font-size:1.3em;"></span>
      </div>
      <button class="secondary-btn" onclick="startKeyScan()">Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡</button>
      <button class="danger-btn" onclick="goHome()">â¬… ĞĞ°Ğ·Ğ°Ğ´ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</button>
    </div>

    <div id="page-scan-key" class="hidden">
      <h1>Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ»ÑÑ‡Ğ°</h1>
      <h2>ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑˆÑ‚Ñ€Ğ¸Ñ…ĞºĞ¾Ğ´ Ñ ĞºĞ»ÑÑ‡Ğ°</h2>
      <div class="qr-area">
        <div id="qr-reader-key"></div>
      </div>
      <button class="danger-btn" onclick="goHome()">â¬… ĞĞ°Ğ·Ğ°Ğ´ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</button>
    </div>

    <div id="page-done" class="hidden">
      <h1 style="color:#43a047; font-size:2em;">âœ…</h1>
      <div class="result-box">ĞŸÑ€Ğ¾Ñ†ĞµÑÑ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!</div>
      <p style="color:#555;">Ğ’Ñ‹ Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞµĞºÑƒĞ½Ğ´...</p>
      <button class="danger-btn" onclick="goHome()">â¬… Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ ÑĞµĞ¹Ñ‡Ğ°Ñ</button>
    </div>
  </div>

  <script>
  let orderData = '';
  let roomList = [];
  let idList = [];
  let count = 0;
  let scanIndex = 0;
  let keyData = '';
  const webhookURL = 'https://hook.integrator.boost.space/erots3p6ehh18tm6yfxmpgxoth6sadfc';

  function showPage(id) {
    document.querySelectorAll('.container > div').forEach(el => el.className = 'hidden');
    document.getElementById(id).className = 'visible';
  }

  function goHome() {
    orderData = '';
    roomList = [];
    idList = [];
    count = 0;
    scanIndex = 0;
    keyData = '';
    document.getElementById('qr-reader-order').innerHTML = '';
    document.getElementById('qr-reader-key').innerHTML = '';
    showPage('page-scan-order');
  }

  function startOrderScan() {
    const scanner = new Html5Qrcode("qr-reader-order");
    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
      text => {
        scanner.stop();
        orderData = text;
        sendWebhook({ order: orderData }, true);
      });
  }

  function startKeyScan() {
    showPage('page-scan-key');
    document.getElementById('qr-reader-key').innerHTML = '';
    const scanner = new Html5Qrcode("qr-reader-key");

    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
      text => {
        scanner.stop();
        keyData = text;

        const payload = {
          order: orderData,
          key: keyData,
          id: idList[scanIndex],
          room: roomList[scanIndex]
        };

        sendWebhook(payload, false, () => {
          scanner.stop();
          startKeyScan(); // × ×¡×” ×©×•×‘
        });
      });
  }

  function sendWebhook(data, isFirst, retryCallback = null) {
    showPage('page-loading');
    document.getElementById('error-box').innerText = '';

    fetch(webhookURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(async res => {
      const body = await res.text();
      const headers = {};
      res.headers.forEach((v, k) => headers[k.toLowerCase()] = v);

      if (isFirst) {
        if (headers.room && headers.id && headers.count) {
          roomList = headers.room.split(',').map(s => s.trim());
          idList = headers.id.split(',').map(s => s.trim());
          count = parseInt(headers.count, 10) || 0;

          if (roomList.length !== count || idList.length !== count) {
            document.getElementById('error-box').innerText = '×©×’×™××”: ××¡×¤×¨ ×”×—×“×¨×™×, ×”××™×™×“×™× ××• ×”-count ×œ× ×ª×•×××™×.';
            return;
          }

          scanIndex = 0;
          document.getElementById('room-number').innerText = roomList[scanIndex];
          showPage('page-room-result');
        } else {
          document.getElementById('error-box').innerText = '×©×’×™××”: ×œ× ×”×ª×§×‘×œ×• ×›×œ ×”× ×ª×•× ×™× ×”×“×¨×•×©×™× ××”Ö¾Webhook.';
        }
      } else {
        if (res.status === 202 && headers.status === 'accepted') {
          scanIndex++;
          if (scanIndex < count) {
            document.getElementById('room-number').innerText = roomList[scanIndex];
            showPage('page-room-result');
          } else {
            showPage('page-done');
            setTimeout(goHome, 3000);
          }
        } else {
          document.getElementById('error-box').innerText = `×©×’×™××”: ×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×ª ××™×©×•×¨\n${res.status} ${body}`;
          if (retryCallback) retryCallback();
        }
      }
    }).catch(err => {
      document.getElementById('error-box').innerText = '×©×’×™××”: ' + err;
      if (retryCallback) retryCallback();
    });
  }

  window.onload = () => {
    goHome();
    startOrderScan();
  }
</script>

</body>
</html>
